<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <title>Bachelor Project Mario Weber</title>

    <!-- CSS  -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

    <!-- CSS Charts -->
    <link href="css/chart4.css" rel="stylesheet">

    <!-- d3.js -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/firebase.js"></script>

</head>
<body>
<div class="navbar-fixed">
    <nav class="green darken-2" role="navigation">
        <div class="nav-wrapper container"><a id="logo-container" href="index.html" class="brand-logo">BVB Delay</a>
            <ul class="right hide-on-med-and-down">
                <li><a href="index.html">HOME</a></li>
                <li><a href="chart1.html">Chart-1</a></li>
                <li><a href="chart2.html">Chart-2</a></li>
                <li><a href="chart3.html">Chart-3</a></li>
                <li><a href="chart4.html">Chart-4</a></li>
            </ul>

            <ul id="nav-mobile" class="side-nav">
                <li><a href="index.html">HOME</a></li>
                <li><a href="chart1.html">Chart-1</a></li>
                <li><a href="chart2.html">Chart-2</a></li>
                <li><a href="chart3.html">Chart-3</a></li>
                <li><a href="chart4.html">Chart-4</a></li>
            </ul>
            <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
        </div>
    </nav>
</div>

<div class="container">
    <div class="row">
        <script>
            var cacheRef = new Firebase('https://bachprojectmw.firebaseio.com/');
            var recordLimit = 25;

            // We'll get up to the initial data so we can prime the chart with some history data


            cacheRef.child("live").limitToLast(recordLimit).once("value", function(snapshot){
                var data = [];
                snapshot.forEach(function(childSnapshot) {
                    var data2 = childSnapshot.val();
                    data.push(data2);
                    // Build the full dataset after getting data from Firebase
                });

                console.log(data);
                var tHeaderData =["Departure", "Tram Nr", "Direction", "Delay", "Scheduled Departure"];
                var table = d3.select("#testing");
                var tHeader = table.append("thead");
                tHeader.append("tr")
                        .selectAll("td")
                        .data(tHeaderData)
                        .enter()
                        .append("td")
                        .style("text-align", "center")
                        .text(function(d){return d;});
                var tBody = table.append("tbody");

                for (var i= 0; i<data.length;i++){
                    var data2 = [data[i].scheduled,
                        data[i].nr,
                        data[i].finalDest,
                        data[i].delay,
                        data[i].realDep
                    ];


                    tBody.append("tr")
                            .selectAll("td")
                            .data(data2)
                            .enter()
                            .append("td")
                            .attr("class", function(d){
                                if (data[i].delay > 0){
                                    return "tolate"
                                } else {
                                    return "";
                                }
                            })
                            .style("text-align", "center")
                            .text(function(d){return d});
                }

            });

            cacheRef.child("live").limitToLast(recordLimit).on("child_changed", function(){
                $("#testing").remove();
                d3.select("#tablediv").append("table").attr("id","testing");
                cacheRef.child("live").limitToLast(recordLimit).once("value", function(snapshot){
                    var data = [];
                    snapshot.forEach(function(childSnapshot) {
                        var data2 = childSnapshot.val();
                        data.push(data2);
                    });

                    //console.log(data);
                    var tHeaderData =["Departure", "Tram Nr", "Direction", "Delay", "Scheduled Departure"];
                    var table = d3.select("#testing");
                    var tHeader = table.append("thead");
                    tHeader.append("tr")
                            .selectAll("td")
                            .data(tHeaderData)
                            .enter()
                            .append("td")
                            .style("text-align", "center")
                            .text(function(d){return d;});
                    var tBody = table.append("tbody");

                    for (var i= 0; i<data.length;i++){
                        var data2 = [data[i].scheduled,
                            data[i].nr,
                            data[i].finalDest,
                            data[i].delay,
                            data[i].realDep
                        ];


                        tBody.append("tr")
                                .selectAll("td")
                                .data(data2)
                                .enter()
                                .append("td")
                                .attr("class", function(d){
                                    if (data[i].delay > 0){
                                        return "tolate"
                                    } else {
                                        return "";
                                    }
                                })
                                .style("text-align", "center")
                                .text(function(d){return d});
                    }

                });
            });
        </script>

        <div class="col s12 m12 l12 class1" id="tablediv">
            <h4>Live Feed from Station: Basel Barf√ºsserplatz</h4>
            <p>(needs script running for updated data)</p>
            <table id="testing">
            </table>
        </div>
        <div class="row">
            <h4>Information on the next 25 trams leaving the station in all directions. Updated every 60s.</h4>
        </div>
    </div>
</div>

<!--  Scripts-->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="js/materialize.js"></script>
<script src="js/init.js"></script>
<script src="js/d3.v3.min.js"></script>
<script src="js/chart4.js"></script>


</body>
</html>
